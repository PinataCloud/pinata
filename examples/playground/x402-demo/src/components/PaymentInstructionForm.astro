---
// PaymentInstructionForm component - Create new payment instructions
---

<div class="card payment-form-card">
  <div class="card-title">
    <svg class="title-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
      <line x1="1" y1="10" x2="23" y2="10"></line>
    </svg>
    <h4>Create Payment Instruction</h4>
  </div>

  <form id="payment-instruction-form" class="payment-form">
    <div class="form-section">
      <div class="section-label">Basic Info</div>

      <div class="form-group">
        <label for="name">Name *</label>
        <input type="text" id="name" name="name" required placeholder="e.g., Premium Content Access" />
      </div>

      <div class="form-group">
        <label for="description">Description <span class="optional">(optional)</span></label>
        <textarea id="description" name="description" rows="2" placeholder="Describe what this payment enables access to"></textarea>
      </div>
    </div>

    <div class="form-section">
      <div class="section-label">Payment Requirement</div>

      <div class="form-row">
        <div class="form-group">
          <label>Asset Contract *</label>
          <input type="text" name="asset" required placeholder="0x036CbD53842c5426634e7929541eC2318f3dCF7e" />
          <span class="form-hint">ERC-20 token contract address</span>
        </div>

        <div class="form-group">
          <label>Recipient Address *</label>
          <input type="text" name="pay_to" required placeholder="0x..." />
          <span class="form-hint">Address to receive payments</span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Network</label>
          <select name="network">
            <option value="base-sepolia">Base Sepolia (Testnet)</option>
            <option value="base">Base (Mainnet)</option>
          </select>
        </div>

        <div class="form-group">
          <label>Amount *</label>
          <input type="text" name="max_amount_required" required placeholder="1000000" />
          <span class="form-hint">In smallest token unit (e.g., wei)</span>
        </div>
      </div>
    </div>

    <button type="submit" class="btn btn-primary submit-btn">
      <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"></path>
      </svg>
      <span class="submit-text">Create Payment Instruction</span>
      <span class="loading" style="display: none;"></span>
    </button>
  </form>
</div>

<script>
  const form = document.getElementById('payment-instruction-form');
  const paymentForm = document.querySelector('.payment-form');

  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const submitBtn = form.querySelector('button[type="submit"]');
    const submitText = submitBtn.querySelector('.submit-text');
    const btnIcon = submitBtn.querySelector('.btn-icon') as HTMLElement;
    const loading = submitBtn.querySelector('.loading');

    // Show loading state
    submitBtn.disabled = true;
    submitText.style.display = 'none';
    btnIcon.style.display = 'none';
    loading.style.display = 'inline-block';

    try {
      const formData = new FormData(form);

      // Collect payment requirements
      const asset = paymentForm.querySelector('[name="asset"]').value;
      const pay_to = paymentForm.querySelector('[name="pay_to"]').value;
      const network = paymentForm.querySelector('[name="network"]').value;
      const max_amount_required = paymentForm.querySelector('[name="max_amount_required"]').value;

      const requirements = [];
      if (asset && pay_to && max_amount_required) {
        requirements.push({
          asset,
          pay_to,
          network,
          max_amount_required
        });
      }

      const payload = {
        name: formData.get('name'),
        description: formData.get('description') || undefined,
        payment_requirements: requirements
      };

      const response = await fetch('/api/payment-instructions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        const result = await response.json();
        window.showAlert('Payment instruction created', 'success');
        form.reset();

        // Refresh payment instructions list
        if (window.refreshPaymentInstructions) {
          window.refreshPaymentInstructions();
        }
      } else {
        const error = await response.json();
        throw new Error(error.error || 'Creation failed');
      }
    } catch (error) {
      console.error('Error creating payment instruction:', error);
      window.showAlert(error.message || 'Creation failed', 'error');
    } finally {
      // Reset loading state
      submitBtn.disabled = false;
      submitText.style.display = 'inline';
      btnIcon.style.display = 'inline';
      loading.style.display = 'none';
    }
  });
</script>

<style>
  .payment-form-card {
    position: relative;
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: 0.625rem;
    margin-bottom: 1.25rem;
  }

  .title-icon {
    color: var(--accent-primary);
  }

  .card-title h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .form-section {
    margin-bottom: 1.5rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .form-section:last-of-type {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 1.5rem;
  }

  .section-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 1rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.375rem;
  }

  .optional {
    color: var(--text-muted);
    font-size: 0.75rem;
    font-weight: 400;
  }

  .submit-btn {
    width: 100%;
    justify-content: center;
    padding: 0.875rem;
  }

  .submit-btn .btn-icon {
    display: inline;
  }

  @media (max-width: 640px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
